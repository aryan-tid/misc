<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3 Omni-Station</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        /* --- THEME VARIABLES --- */
        :root {
            /* Default (Cyberpunk Green) */
            --primary: #00dc82; 
            --primary-dim: rgba(0, 220, 130, 0.1);
            --bg: #04090b;
            --glass: rgba(10, 25, 30, 0.75);
            --glass-border: rgba(0, 220, 130, 0.2);
            --text-main: #e0e7ff;
            --text-sec: #94a3b8;
        }

        /* Nebula Theme */
        [data-theme="nebula"] {
            --primary: #a855f7;
            --primary-dim: rgba(168, 85, 247, 0.1);
            --bg: #0f0720;
            --glass: rgba(20, 10, 40, 0.75);
            --glass-border: rgba(168, 85, 247, 0.2);
        }

        /* Sunset Theme */
        [data-theme="sunset"] {
            --primary: #f59e0b;
            --primary-dim: rgba(245, 158, 11, 0.1);
            --bg: #1a0f0a;
            --glass: rgba(40, 20, 10, 0.75);
            --glass-border: rgba(245, 158, 11, 0.2);
        }

        /* Midnight (Blue) Theme */
        [data-theme="midnight"] {
            --primary: #3b82f6;
            --primary-dim: rgba(59, 130, 246, 0.1);
            --bg: #020617;
            --glass: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(59, 130, 246, 0.2);
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Space Grotesk', sans-serif;
            overflow: hidden;
            /* Changed from 100vh to 100dvh to fit mobile screens perfectly */
            height: 100dvh; 
            width: 100%;
            transition: background-color 0.5s ease;
        }

        main {
            height: 100dvh; /* Force full dynamic height */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent double scrollbars */
        }

        .input-zone {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Shiny Glass Classes */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        /* Ambient Light Animation */
        .ambient-light {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, var(--primary-dim) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, var(--primary-dim) 0%, transparent 40%);
            z-index: -1;
            animation: pulseLight 8s infinite alternate;
        }
        @keyframes pulseLight { 0% { opacity: 0.4; } 100% { opacity: 0.8; } }

        /* Typography & Code */
        pre { 
            border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.1) !important; 
            margin: 1rem 0; 
            background: #0d1117 !important;
            position: relative;
        }
        code { font-family: 'JetBrains Mono', monospace !important; font-size: 0.9em; }
        
        .copy-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(255,255,255,0.1); border: none; color: #888;
            border-radius: 4px; padding: 4px 8px; font-size: 10px;
            cursor: pointer; transition: 0.2s;
        }
        .copy-btn:hover { background: var(--primary); color: #000; }

        /* Toggles & Inputs */
        .accent-text { color: var(--primary); }
        .accent-bg { background-color: var(--primary); }
        .accent-border { border-color: var(--primary); }
        
        .toggle-checkbox:checked { right: 0; border-color: var(--primary); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--primary); }
        
        .toggle-label { width: 36px; height: 20px; position: relative; display: block; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Animations */
        .msg-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        .active-chat { background: linear-gradient(90deg, var(--primary-dim), transparent); border-left: 3px solid var(--primary); }
        
        /* PDF Export Styles (Hidden by default) */
        #pdf-container { display: none; }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: var(--glass);
            border: 1px solid var(--primary); color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 999;
            left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body class="flex flex-col md:flex-row relative transition-colors duration-500">
    <div class="ambient-light"></div>
    
    <div id="toast">Settings Saved Successfully</div>

    <aside id="sidebar" class="w-72 glass-panel border-r-0 border-r border-white/5 flex flex-col z-50 transition-transform duration-300 fixed md:relative h-full -translate-x-full md:translate-x-0 bg-[var(--bg)] md:bg-transparent">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <i class="fa fa-cube text-2xl accent-text"></i>
                    <h1 class="text-xl font-bold tracking-tight text-white">GEMMA <span class="accent-text">3</span></h1>
                </div>
                <button onclick="document.getElementById('sidebar').classList.add('-translate-x-full')" class="md:hidden text-gray-400 hover:text-white p-2">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>

            <button onclick="createNewChat(); if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full')" class="w-full py-3 px-4 rounded-lg accent-bg text-black font-bold transition hover:brightness-110 flex items-center justify-center gap-2 shadow-lg">
                <i class="fa fa-plus"></i> New Chat
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-list">
            </div>

        <div class="p-4 mt-auto border-t border-white/5 space-y-2">
            <button onclick="toggleSettings(); if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full')" class="w-full p-3 rounded-lg hover:bg-white/5 var(--text-sec) transition flex items-center gap-3 text-sm text-gray-400">
                <i class="fa fa-sliders"></i> System Settings
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative z-10">
        <header class="md:hidden p-4 glass-panel border-b-0 flex justify-between items-center">
            <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')"><i class="fa fa-bars text-xl"></i></button>
            <span class="font-bold accent-text">OMNI-STATION</span>
            <div class="w-6"></div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div id="welcome-state" class="h-full flex flex-col items-center justify-center opacity-80">
                <div class="w-24 h-24 rounded-full accent-bg bg-opacity-10 flex items-center justify-center mb-6 animate-pulse" style="background: var(--primary-dim)">
                    <i class="fa fa-fingerprint text-4xl accent-text"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2">System Online</h2>
                <p class="text-gray-500 mb-8" id="welcome-model-text">Gemma 3 27B-IT â€¢ Ready</p>
                <div class="flex gap-4 flex-wrap justify-center">
                    <button onclick="quickStart('Draft a quarterly report')" class="px-6 py-3 rounded-full glass-panel hover:border-[var(--primary)] transition text-sm">ðŸ“Š Business</button>
                    <button onclick="quickStart('Create a React Hook')" class="px-6 py-3 rounded-full glass-panel hover:border-[var(--primary)] transition text-sm">ðŸ’» Code</button>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-gradient-to-t from-[var(--bg)] via-[var(--bg)] to-transparent">
            <div class="max-w-4xl mx-auto glass-panel rounded-2xl p-2 relative flex items-end gap-2 shadow-2xl">
                <button id="mic-btn" onclick="toggleVoice()" class="w-10 h-10 rounded-xl hover:bg-white/10 text-gray-400 transition flex-shrink-0 flex items-center justify-center">
                    <i class="fa fa-microphone"></i>
                </button>

                <textarea id="prompt-input" rows="1" placeholder="Enter a message..." 
                    class="flex-1 bg-transparent border-none focus:ring-0 p-3 text-gray-200 resize-none max-h-48 font-[Space_Grotesk]"
                    oninput="autoResize(this)" onkeydown="handleInputKey(event)"></textarea>

                <button id="send-btn" onclick="handleSend()" class="w-10 h-10 rounded-xl accent-bg text-black font-bold flex items-center justify-center transition flex-shrink-0 hover:brightness-110">
                    <i class="fa fa-arrow-up"></i>
                </button>
            </div>

            <div class="max-w-4xl mx-auto flex flex-wrap justify-between items-center mt-3 px-2 gap-2">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Context</span>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" id="context-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                            <label for="context-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 text-[10px] text-gray-500 uppercase tracking-widest items-center">
                    <span id="token-display">Tokens: 0</span>
                    <button onclick="exportPDF()" class="hover:text-[var(--primary)] transition flex items-center gap-1" title="Download PDF">
                        <i class="fa fa-file-pdf"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 md:p-8 relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="fa fa-sliders accent-text"></i> Settings</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold accent-text uppercase tracking-wider block mb-2">Interface Theme</label>
                    <div class="grid grid-cols-4 gap-2">
                        <div onclick="setTheme('default')" class="h-8 rounded cursor-pointer bg-[#00dc82] ring-2 ring-offset-2 ring-offset-black ring-transparent hover:ring-white transition" title="Cyberpunk"></div>
                        <div onclick="setTheme('nebula')" class="h-8 rounded cursor-pointer bg-[#a855f7] ring-2 ring-offset-2 ring-offset-black ring-transparent hover:ring-white transition" title="Nebula"></div>
                        <div onclick="setTheme('sunset')" class="h-8 rounded cursor-pointer bg-[#f59e0b] ring-2 ring-offset-2 ring-offset-black ring-transparent hover:ring-white transition" title="Sunset"></div>
                        <div onclick="setTheme('midnight')" class="h-8 rounded cursor-pointer bg-[#3b82f6] ring-2 ring-offset-2 ring-offset-black ring-transparent hover:ring-white transition" title="Midnight"></div>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold accent-text uppercase tracking-wider block mb-2">API Key</label>
                    <input type="password" id="api-key" placeholder="Paste Gemini API Key..." class="w-full bg-[#04090b] border border-white/10 rounded-lg p-3 text-sm focus:border-[var(--primary)] outline-none">
                </div>

                <div>
                    <label class="text-xs font-bold accent-text uppercase tracking-wider block mb-2">Model</label>
                    <select id="model-select" class="w-full bg-[#04090b] border border-white/10 rounded-lg p-3 text-sm focus:border-[var(--primary)] outline-none text-gray-300">
                        <option value="gemma-3-27b-it">Gemma 3 27B IT</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold accent-text uppercase tracking-wider block mb-2">System Persona</label>
                    <textarea id="system-instruction" rows="2" placeholder="e.g. Be concise." class="w-full bg-[#04090b] border border-white/10 rounded-lg p-3 text-sm focus:border-[var(--primary)] outline-none resize-none"></textarea>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold accent-text uppercase tracking-wider">Creativity</label>
                        <span id="temp-val" class="text-xs font-mono">0.7</span>
                    </div>
                    <input type="range" id="temp-slider" min="0" max="1" step="0.1" value="0.7" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('temp-val').innerText = this.value">
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full mt-8 py-3 rounded-lg accent-bg text-black font-bold transition hover:brightness-110">Save Configuration</button>
        </div>
    </div>

    <div id="pdf-container"></div>

    <script>
        // --- Markdown & UI Init ---
        const md = window.markdownit({
            html: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return `<div class="relative group my-2">
                                    <button class="copy-btn hidden group-hover:block" onclick="copyToClipboard(this)">Copy</button>
                                    <pre class="hljs"><code>${hljs.highlight(str, { language: lang, ignoreIllegals: true }).value}</code></pre>
                                </div>`;
                    } catch (__) {}
                }
                return `<pre class="hljs"><code>${md.utils.escapeHtml(str)}</code></pre>`;
            }
        });

        // --- Global State ---
        let chats = JSON.parse(localStorage.getItem('gemma_chats')) || [];
        let currentChatId = localStorage.getItem('gemma_active_id') || null;
        let recognition;
        let abortController = null; // For stopping generation

        // --- Lifecycle ---
        window.onload = () => {
            loadConfig();
            renderChatList();
            if(currentChatId) loadChat(currentChatId);
            setupVoice();
        };

        // --- Settings & Themes ---
        function loadConfig() {
            const keys = ['gemma_api_key', 'gemma_system_prompt', 'gemma_temp', 'gemma_model', 'gemma_theme'];
            keys.forEach(k => {
                const val = localStorage.getItem(k);
                if(!val) return;
                
                if(k === 'gemma_api_key') document.getElementById('api-key').value = val;
                if(k === 'gemma_system_prompt') document.getElementById('system-instruction').value = val;
                if(k === 'gemma_temp') { document.getElementById('temp-slider').value = val; document.getElementById('temp-val').innerText = val; }
                if(k === 'gemma_model') { document.getElementById('model-select').value = val; updateModelText(val); }
                if(k === 'gemma_theme') setTheme(val, false);
            });

            const ctx = localStorage.getItem('gemma_context');
            if(ctx !== null) document.getElementById('context-toggle').checked = (ctx === 'true');

            // Save Context Listener
            document.getElementById('context-toggle').addEventListener('change', (e) => localStorage.setItem('gemma_context', e.target.checked));
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }

        function setTheme(themeName, save = true) {
            document.body.setAttribute('data-theme', themeName);
            if(save) {
                localStorage.setItem('gemma_theme', themeName);
                showToast(`Theme set to ${themeName}`);
            }
        }

        function saveSettings() {
            localStorage.setItem('gemma_api_key', document.getElementById('api-key').value.trim());
            localStorage.setItem('gemma_system_prompt', document.getElementById('system-instruction').value.trim());
            localStorage.setItem('gemma_temp', document.getElementById('temp-slider').value);
            const model = document.getElementById('model-select').value;
            localStorage.setItem('gemma_model', model);
            
            updateModelText(model);
            toggleSettings();
            showToast("Settings Saved Successfully");
        }

        function updateModelText(model) {
            const cleanName = model.replace('gemini-', '').replace('gemma-', '').toUpperCase();
            document.getElementById('welcome-model-text').innerText = `${cleanName} â€¢ Ready`;
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.className = "show";
            setTimeout(() => { el.className = el.className.replace("show", ""); }, 3000);
        }

        // --- Input Handling ---
        function autoResize(el) {
            el.style.height = 'auto'; 
            el.style.height = el.scrollHeight + 'px';
        }

        function handleInputKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default newline
                handleSend();
            }
            // Shift+Enter will do default (newline)
        }

        // --- Chat Logic ---
        function createNewChat() {
            const id = Date.now().toString();
            chats.unshift({ id, title: "New Conversation", messages: [] });
            saveChats();
            renderChatList();
            loadChat(id);
        }

        function loadChat(id) {
            currentChatId = id;
            localStorage.setItem('gemma_active_id', id);
            
            const chat = chats.find(c => c.id === id);
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            
            if(chat.messages.length === 0) {
                container.innerHTML = document.getElementById('welcome-state').outerHTML;
                document.getElementById('welcome-state').style.display = 'flex';
                updateModelText(localStorage.getItem('gemma_model') || 'Gemma 3');
            } else {
                chat.messages.forEach(m => appendMessage(m.role, m.content));
            }
            renderChatList();
            updateTokenCount(chat);
        }

        function quickStart(txt) {
            document.getElementById('prompt-input').value = txt;
            handleSend();
        }

        async function handleSend() {
            const input = document.getElementById('prompt-input');
            const text = input.value.trim();
            const apiKey = localStorage.getItem('gemma_api_key');

            if (abortController) {
                // If currently generating, Stop it.
                abortController.abort();
                abortController = null;
                document.getElementById('send-btn').innerHTML = '<i class="fa fa-arrow-up"></i>';
                document.querySelector('.generating-loader')?.remove();
                return;
            }
            
            if(!text) return;
            if(!apiKey) { toggleSettings(); return; }
            if(!currentChatId) createNewChat();

            // Clear Welcome
            const welcome = document.getElementById('welcome-state');
            if(welcome) welcome.remove();

            // UI Updates
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('send-btn').innerHTML = '<i class="fa fa-stop text-red-500"></i>';

            appendMessage('user', text);
            const chat = chats.find(c => c.id === currentChatId);
            chat.messages.push({ role: 'user', content: text });

            if(chat.title === 'New Conversation') {
                chat.title = text.substring(0, 30);
                renderChatList();
            }

            // Create Loader
            const loaderId = 'load-' + Date.now();
            const loader = document.createElement('div');
            loader.className = 'flex gap-4 p-2 generating-loader';
            loader.id = loaderId;
            loader.innerHTML = `<div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><i class="fa fa-circle-notch animate-spin accent-text"></i></div>`;
            document.getElementById('chat-container').appendChild(loader);
            document.getElementById('chat-container').scrollTo(0, 99999);

            // API Prep
            abortController = new AbortController();
            const contextOn = document.getElementById('context-toggle').checked;
            const model = localStorage.getItem('gemma_model') || 'gemma-3-27b-it';
            const sys = localStorage.getItem('gemma_system_prompt');
            const temp = parseFloat(localStorage.getItem('gemma_temp') || 0.7);

            let contents = contextOn ? 
                chat.messages.map(m => ({ role: m.role==='user'?'user':'model', parts: [{ text: m.content }] })) : 
                [{ role: 'user', parts: [{ text }] }];

            let body = {
                contents: contents,
                generationConfig: { temperature: temp, maxOutputTokens: 4000 }
            };
            if(sys) body.systemInstruction = { parts: [{ text: sys }] };

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: abortController.signal
                });

                const data = await res.json();
                document.getElementById(loaderId).remove();
                abortController = null;
                document.getElementById('send-btn').innerHTML = '<i class="fa fa-arrow-up"></i>';

                if(data.error) throw new Error(data.error.message);

                const aiText = data.candidates[0].content.parts[0].text;
                chat.messages.push({ role: 'model', content: aiText });
                appendMessage('model', aiText);
                saveChats();
                updateTokenCount(chat);

            } catch(e) {
                if(document.getElementById(loaderId)) document.getElementById(loaderId).remove();
                if(e.name !== 'AbortError') appendMessage('model', `**Error:** ${e.message}`);
                abortController = null;
                document.getElementById('send-btn').innerHTML = '<i class="fa fa-arrow-up"></i>';
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex gap-4 mb-6 msg-enter ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center ${role==='user'?'accent-bg text-black':'glass-panel text-white'}">
                    <i class="fa ${role==='user'?'fa-user':'fa-robot'} text-sm"></i>
                </div>
                <div class="glass-panel p-4 md:p-6 rounded-2xl max-w-[85%] prose prose-invert prose-p:leading-relaxed ${role==='user'?'accent-border':''}">
                    ${md.render(text)}
                </div>
            `;
            const container = document.getElementById('chat-container');
            container.appendChild(div);
            container.scrollTo(0, container.scrollHeight);
        }

        // --- PDF Export Logic ---
        function exportPDF() {
            if(!currentChatId) return showToast("No chat to export!");
            
            showToast("Generating PDF...");
            const chat = chats.find(c => c.id === currentChatId);
            
            // 1. Create a temporary 'Print Friendly' container
            const printDiv = document.createElement('div');
            printDiv.style.padding = "40px";
            printDiv.style.color = "black";
            printDiv.style.background = "white";
            printDiv.style.fontFamily = "sans-serif";

            // Header
            printDiv.innerHTML = `
                <h1 style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">${chat.title}</h1>
                <p style="color: #666; font-size: 12px; margin-bottom: 30px;">Exported from Gemma 3 Omni-Station â€¢ ${new Date().toLocaleString()}</p>
            `;

            // Content
            chat.messages.forEach(msg => {
                const roleColor = msg.role === 'user' ? '#00dc82' : '#3b82f6';
                const roleName = msg.role === 'user' ? 'You' : 'AI';
                const contentHtml = md.render(msg.content);
                
                printDiv.innerHTML += `
                    <div style="margin-bottom: 20px;">
                        <strong style="color: ${roleColor}; text-transform: uppercase; font-size: 12px;">${roleName}</strong>
                        <div style="margin-top: 5px; line-height: 1.5; font-size: 14px; color: #333;">${contentHtml}</div>
                    </div>
                `;
            });

            // 2. Generate PDF
            const opt = {
                margin: 0.5,
                filename: `Gemma_Chat_${Date.now()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // We need to append to body briefly for html2pdf to see it, then remove
            // But html2pdf can take an element directly.
            
            // To ensure styles (like code blocks) look okay in white mode, we might need a quick CSS fix or just accept basic markdown styling.
            // The `prose-invert` classes from main app won't apply here, which is GOOD because we want black text.
            
            html2pdf().set(opt).from(printDiv).save().then(() => {
                showToast("PDF Downloaded!");
            });
        }

        // --- Helper Utils ---
        function renderChatList() {
            const el = document.getElementById('chat-list');
            el.innerHTML = '';
            chats.forEach(c => {
                const btn = document.createElement('div');
                btn.className = `p-3 rounded-lg cursor-pointer flex justify-between items-center group transition hover:bg-white/5 ${c.id === currentChatId ? 'active-chat' : ''}`;
                btn.onclick = () => loadChat(c.id);
                btn.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa fa-message text-gray-500 text-xs"></i>
                        <span class="text-sm truncate text-gray-300 font-medium">${c.title}</span>
                    </div>
                    <i class="fa fa-trash text-xs text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-2" onclick="deleteChat(event, '${c.id}')"></i>
                `;
                el.appendChild(btn);
            });
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(!confirm('Delete this conversation?')) return;
            chats = chats.filter(c => c.id !== id);
            saveChats();
            if(currentChatId === id) {
                currentChatId = null;
                document.getElementById('chat-container').innerHTML = '';
            }
            renderChatList();
        }

        function saveChats() { localStorage.setItem('gemma_chats', JSON.stringify(chats)); }
        function updateTokenCount(chat) {
            const txt = JSON.stringify(chat.messages);
            document.getElementById('token-display').innerText = `Tokens: ~${Math.ceil(txt.length/4)}`;
        }
        function copyToClipboard(btn) {
            navigator.clipboard.writeText(btn.nextElementSibling.innerText);
            const orig = btn.innerText; btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = orig, 1500);
        }

        // --- Voice ---
        function setupVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onresult = (e) => {
                    const t = e.results[0][0].transcript;
                    const inp = document.getElementById('prompt-input');
                    inp.value += (inp.value ? ' ' : '') + t;
                    autoResize(inp);
                    toggleVoice();
                };
                recognition.onerror = () => toggleVoice();
            } else { document.getElementById('mic-btn').style.display = 'none'; }
        }
        function toggleVoice() {
            const btn = document.getElementById('mic-btn');
            if(btn.classList.contains('text-red-500')) {
                recognition.stop();
                btn.classList.remove('text-red-500', 'animate-pulse');
            } else {
                recognition.start();
                btn.classList.add('text-red-500', 'animate-pulse');
            }
        }
    </script>
</body>
</html>
